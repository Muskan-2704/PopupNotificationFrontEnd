const visitLinkLightSVG = `<svg xmlns="http://www.w3.org/2000/svg" id="Visit_Link_icon_light" data-name="Visit Link icon" width="14" height="16" viewBox="0 -4 22 24">
                                <path id="Path_223" data-name="Path 223" d="M0,0H22V24H0Z" fill="none"/>
                                <path id="open_in_new_FILL0_wght400_GRAD0_opsz48_1_" data-name="open_in_new_FILL0_wght400_GRAD0_opsz48 (1)" d="M121.167,230A1.2,1.2,0,0,1,120,228.833V217.167A1.2,1.2,0,0,1,121.167,216h4.842a.563.563,0,0,1,.416.169.57.57,0,0,1,.168.418.558.558,0,0,1-.168.415.569.569,0,0,1-.416.165h-4.842v11.667h11.667v-4.842a.563.563,0,0,1,.169-.416.569.569,0,0,1,.418-.168.558.558,0,0,1,.415.168.569.569,0,0,1,.165.416v4.842A1.2,1.2,0,0,1,132.833,230Zm3.522-4.694a.6.6,0,0,1-.168-.4.526.526,0,0,1,.165-.408l7.331-7.331h-3.675a.563.563,0,0,1-.416-.169.57.57,0,0,1-.168-.418.558.558,0,0,1,.168-.415.569.569,0,0,1,.416-.165h5.075a.573.573,0,0,1,.583.583v5.075a.563.563,0,0,1-.169.416.569.569,0,0,1-.418.168.558.558,0,0,1-.415-.168.569.569,0,0,1-.165-.416V218l-7.331,7.331a.564.564,0,0,1-.4.156A.546.546,0,0,1,124.689,225.306Z" transform="translate(-115 -211)" fill="#fff"/>
                            </svg>`;
const visitLinkDarkSVG = `<svg xmlns="http://www.w3.org/2000/svg" id="Visit_Link_icon_dark" data-name="Visit Link icon" width="16" height="16" viewBox="0 -4 24 24">
                            <path id="Path_223" data-name="Path 223" d="M0,0H24V24H0Z" fill="none"/>
                            <path id="Union_1" data-name="Union 1" d="M-811.334-381a1.63,1.63,0,0,1-1.17-.5,1.627,1.627,0,0,1-.5-1.17v-11.667a1.626,1.626,0,0,1,.5-1.17,1.63,1.63,0,0,1,1.17-.5h2.842a1.063,1.063,0,0,1,.77.316,1.072,1.072,0,0,1,.313.77,1.059,1.059,0,0,1-.317.771,1.069,1.069,0,0,1-.767.309h-2.342v10.667h10.667v-2.342a1.06,1.06,0,0,1,.316-.77,1.068,1.068,0,0,1,.77-.313,1.055,1.055,0,0,1,.771.317,1.066,1.066,0,0,1,.309.766v2.842a1.627,1.627,0,0,1-.5,1.17,1.63,1.63,0,0,1-1.171.5Zm3.159-4.851a1.106,1.106,0,0,1-.3-.723,1.026,1.026,0,0,1,.311-.783l6.477-6.477h-2.468a1.06,1.06,0,0,1-.77-.316,1.068,1.068,0,0,1-.313-.77,1.057,1.057,0,0,1,.317-.77,1.069,1.069,0,0,1,.767-.31h5.075a1.065,1.065,0,0,1,.769.314,1.062,1.062,0,0,1,.314.77v5.075a1.06,1.06,0,0,1-.316.77,1.068,1.068,0,0,1-.77.313,1.057,1.057,0,0,1-.771-.317,1.07,1.07,0,0,1-.309-.766v-2.449l-6.477,6.477-.009.009a1.065,1.065,0,0,1-.747.293A1.044,1.044,0,0,1-808.175-385.851Z" transform="translate(817.5 400.5)" fill="#525252"/>
                        </svg>`;
const expandCollaspeSVG = `<svg xmlns="http://www.w3.org/2000/svg" id="Expand" width="16" height="16" viewBox="0 -4 24 24">
                            <path id="Path_832" data-name="Path 832" d="M0,0H24V24H0Z" fill="none"></path>
                            <path id="Path_10970" data-name="Path 10970"
                            d="M6.991.419.419,6.991A1.428,1.428,0,0,0,2.438,9.009l5.57-5.555,5.555,5.555a1.428,1.428,0,0,0,2.019-2.019L9.009.419A1.426,1.426,0,0,0,6.991.419Z"
                            transform="translate(20 16.714) rotate(180)" fill="#525252"></path>
                        </svg>`;
const newNotificationSVG = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="new-notification" width="48" height="52" viewBox="0 0 48 52">
                                <defs>
                                <linearGradient id="linear-gradient" x1="-0.23" y1="-0.122" x2="1.147" y2="1.211" gradientUnits="objectBoundingBox">
                                    <stop offset="0" stop-color="#e41165"/>
                                    <stop offset="1" stop-color="#4d2f9e"/>
                                </linearGradient>
                                </defs>
                                <g id="Group_6960" data-name="Group 6960" transform="translate(-24 -18)">
                                <g id="Announcements_Placeholder" data-name="Announcements Placeholder" transform="translate(24 18)">
                                    <g id="Announcements_Placeholder_icon" data-name="Announcements Placeholder icon">
                                    <g id="Ellipse" fill="#f5f2fc" stroke="#e5dff7" stroke-width="1">
                                        <circle cx="24" cy="24" r="24" stroke="none"/>
                                        <circle cx="24" cy="24" r="23.5" fill="none"/>
                                    </g>
                                    <path id="Union_3" data-name="Union 3" d="M827.162-4088.274v-6.779h-1.629a1.475,1.475,0,0,1-1.083-.45,1.475,1.475,0,0,1-.45-1.082v-3.068a1.476,1.476,0,0,1,.45-1.082,1.48,1.48,0,0,1,1.083-.45h4.6l3.961-2.377a.7.7,0,0,1,.767,0,.732.732,0,0,1,.383.667v9.558a.732.732,0,0,1-.383.667.7.7,0,0,1-.767,0l-3.961-2.377h-1.271v6.779a.85.85,0,0,1-.85.85A.85.85,0,0,1,827.162-4088.274Zm-1.629-8.311h5.009l3.169,1.891v-6.85l-3.169,1.891h-5.009Zm15.743,6.184-1.866-1.38a.8.8,0,0,1-.306-.507.7.7,0,0,1,.154-.567.806.806,0,0,1,.506-.306.7.7,0,0,1,.567.153l1.866,1.381a.8.8,0,0,1,.306.506.7.7,0,0,1-.154.567.8.8,0,0,1-.506.307.735.735,0,0,1-.119.01A.722.722,0,0,1,841.276-4090.4Zm-5.009-11.143a4.688,4.688,0,0,1,1.112,1.5,4.415,4.415,0,0,1,.422,1.93,4.413,4.413,0,0,1-.422,1.929,4.687,4.687,0,0,1-1.112,1.5Zm5.111,4.192a.739.739,0,0,1-.546-.222.75.75,0,0,1-.221-.55.733.733,0,0,1,.221-.545.748.748,0,0,1,.546-.218h2.3a.738.738,0,0,1,.546.223.746.746,0,0,1,.221.549.733.733,0,0,1-.221.545.749.749,0,0,1-.546.218Zm-1.537-5.75a.8.8,0,0,1-.507-.307.688.688,0,0,1-.154-.563.8.8,0,0,1,.307-.51l1.789-1.355a.7.7,0,0,1,.567-.154.808.808,0,0,1,.506.307.682.682,0,0,1,.154.562.811.811,0,0,1-.306.512l-1.789,1.354a.723.723,0,0,1-.448.164A.756.756,0,0,1,839.84-4103.1Z" transform="translate(-810.222 4120.715)" fill="#3400c4" opacity="0.16"/>
                                    </g>
                                    <circle id="Ellipse-2" data-name="Ellipse" cx="24" cy="24" r="24" fill="none" opacity="0.999"/>
                                </g>
                                <g id="New_post" data-name="New post" transform="translate(29 51)">
                                    <g id="Rectangle_1895" data-name="Rectangle 1895" transform="translate(0 1)" stroke="#fff" stroke-width="1" fill="url(#linear-gradient)">
                                    <rect width="38" height="18" rx="9" stroke="none"/>
                                    <rect x="0.5" y="0.5" width="37" height="17" rx="8.5" fill="none"/>
                                    </g>
                                    <text id="new" transform="translate(8 13)" fill="#fff" font-size="12" font-family="Roboto-Regular, Roboto" letter-spacing="0em"><tspan x="0" y="0">new</tspan></text>
                                </g>
                                </g>
                            </svg>`;
const notificationSVG = `<svg xmlns="http://www.w3.org/2000/svg" id="Announcements_Placeholder" data-name="Announcements Placeholder"
                            width="48" height="48" viewBox="0 0 48 48">
                            <g id="Announcements_Placeholder_icon" data-name="Announcements Placeholder icon">
                            <g id="Ellipse" fill="#f5f2fc" stroke="#e5dff7" stroke-width="1">
                                <circle cx="24" cy="24" r="24" stroke="none"></circle>
                                <circle cx="24" cy="24" r="23.5" fill="none"></circle>
                            </g>
                            <path id="Union_3" data-name="Union 3"
                                d="M827.162-4088.274v-6.779h-1.629a1.475,1.475,0,0,1-1.083-.45,1.475,1.475,0,0,1-.45-1.082v-3.068a1.476,1.476,0,0,1,.45-1.082,1.48,1.48,0,0,1,1.083-.45h4.6l3.961-2.377a.7.7,0,0,1,.767,0,.732.732,0,0,1,.383.667v9.558a.732.732,0,0,1-.383.667.7.7,0,0,1-.767,0l-3.961-2.377h-1.271v6.779a.85.85,0,0,1-.85.85A.85.85,0,0,1,827.162-4088.274Zm-1.629-8.311h5.009l3.169,1.891v-6.85l-3.169,1.891h-5.009Zm15.743,6.184-1.866-1.38a.8.8,0,0,1-.306-.507.7.7,0,0,1,.154-.567.806.806,0,0,1,.506-.306.7.7,0,0,1,.567.153l1.866,1.381a.8.8,0,0,1,.306.506.7.7,0,0,1-.154.567.8.8,0,0,1-.506.307.735.735,0,0,1-.119.01A.722.722,0,0,1,841.276-4090.4Zm-5.009-11.143a4.688,4.688,0,0,1,1.112,1.5,4.415,4.415,0,0,1,.422,1.93,4.413,4.413,0,0,1-.422,1.929,4.687,4.687,0,0,1-1.112,1.5Zm5.111,4.192a.739.739,0,0,1-.546-.222.75.75,0,0,1-.221-.55.733.733,0,0,1,.221-.545.748.748,0,0,1,.546-.218h2.3a.738.738,0,0,1,.546.223.746.746,0,0,1,.221.549.733.733,0,0,1-.221.545.749.749,0,0,1-.546.218Zm-1.537-5.75a.8.8,0,0,1-.507-.307.688.688,0,0,1-.154-.563.8.8,0,0,1,.307-.51l1.789-1.355a.7.7,0,0,1,.567-.154.808.808,0,0,1,.506.307.682.682,0,0,1,.154.562.811.811,0,0,1-.306.512l-1.789,1.354a.723.723,0,0,1-.448.164A.756.756,0,0,1,839.84-4103.1Z"
                                transform="translate(-810.222 4120.715)" fill="#3400c4" opacity="0.16"></path>
                            </g>
                            <circle id="Ellipse-2" data-name="Ellipse" cx="24" cy="24" r="24" fill="none" opacity="0.999"></circle>
                        </svg>`;
const init = async () => {   
    let token = await chrome.runtime.sendMessage('authorization');
    initialCall(token);
}
const initialCall = (token) => {
    getNotifications(token).then(function(response){
        console.log(JSON.parse(response));
        setTimeout(function(){
            getNotifications(token).then(function(response){
                var jsonRep = JSON.parse(response); 
                chrome.storage.local.get(["user-notification"]).then(async (result)=> {
                    result = Object.keys(result).length === 0 && result.constructor === Object ? [] : result["user-notification"];
                    initPopup(jsonRep, result);
                    PopUpNotification(jsonRep);
                })
                
            });
        }, 3000)
    })

}

const formatAMPM = (date) => {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0'+minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

const getValidNotification = (result) => {
    if(!result || typeof result == typeof {}){
        return [];
    }
    return result.filter(x=>x.id && x.content_title && x.expiry_date > new Date().getTime());
}

const getCategories = result => {
    if(!result || typeof result == typeof {}){
        return [];
    }
    return result.map((item)=> item.category);
}

function removeDuplicates(arr) {
    return [...new Set(arr)];
}

const PopUpNotification = (result) => {
    chrome.storage.local.get(["user-notification"]).then(async (res) => {
        let container = document.querySelector('header');
        let url = location.href;
        if(url.startsWith('https://calendar.google.com/'))
            container = document.querySelector('[jsaction="JC9ySb:npT2md;MNWSEd:Nw4V6c;"]');
        else if(url.startsWith('https://drive.google.com/'))
            container = document.querySelector('.Hb-ja-Na')
        else {
            container = document.querySelector('header');
            container = container ? container.querySelector('[data-tooltip=Settings]').parentElement: container
        }
        if (container) {
            let elementExist = container.querySelector('.Notification-container span');
            if(elementExist) {
                elementExist.innerHTML = res["user-notification"].filter(x=> !x.isRead).length;
            }else {
                let tempElement = document.createElement('div');
                tempElement.setAttribute("class", "Notification-container");
                tempElement.innerHTML = `<div class="Notification"><span style="position:relative;"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"></path><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-1.29 1.29c-.63.63-.19 1.71.7 1.71h13.17c.89 0 1.34-1.08.71-1.71L18 16z"></path></svg></span><span class="nbadge">${res["user-notification"].filter(x=> !x.isRead).length}</span></div>`
                tempElement.addEventListener('click', function(){
                    $('.notifications').toggleClass('hide');
                })
                container.insertBefore(tempElement, container.childNodes[1]);
                if(url.startsWith('https://calendar.google.com/'))
                    container.parentElement.style.height = '60px';
            }
        }
    })
}

function getNotifications(token) {
    let requestObject = {
    method: 'GET',
    async: true,
    headers: {
        Authorization: 'Bearer ' + token,
        'Content-Type': 'application/json'
    }
    };
    var fileId = "1hzU5-4nSlB5ZchFaKVaRU0xQjGlDyZKW"; //"1TJpoAapWc6JXhTSAoR49ekHyhq3VNYnz";
    var fileurl = 'https://www.googleapis.com/drive/v3/files/' + fileId + '?alt=media';
    return fetch(fileurl, requestObject)
    .then(r => r.text());
}
      
const createPopupNotification = (pushNotifications, iterator, cat) => {
    pushNotifications.push(
        `   <div class="popup-container-top">
                <div class="w-14">
                    <img class="popup-image"
                        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAACXBIWXMAAAsTAAALEwEAmpwYAAACL0lEQVR4nO3W24tNYRjH8c+MochxSCFppBxD0VCSC4dxM1dqQs4XiqLkkMjFUHKniBKSaUqGi3EshxxuiAaJDMmN3PoftPTsWu1mH9Zu75m52L96WvWu9b7r+z7vc3ipq666MmkEruAbjhkG2ooejMYbzBoKiJHowEv8wfEYv4nWwQSZiTP4jotYgF1lAM2rJkQj2tCLPuzFBDTF+1JAu9FVDZApOIqv8aOVmBrPQ2iP73akgjkfaCG+YGKpnzWE+2cPYKtjRwnIEUzGihhLFt+St9ZYNBcASuYsLwXTHK5/gWd59hY/4ogaY/fvcD/Gko0UU6agThbbjIc4V+CbRbiTyqQkNlpKrLsUa1JAT7CzDHjXo4BdxsEygMpVflBvx9XIwoKaHkUr0f4aA7WGd3JFMsnGSWHjc5OSzLgxiEDCQ+txIGI2sffhnP8p/Cn6zmAANeEjphWbeArPca/GQIfxCCfKmZxkxCVcqCFQF9ZmWWBMpP7vOMa+lP2K8T3RvSsBStehOVnAboXHxFkvw9NoCWejgZ7HXJUDXYvelwloflTnnvDO4ng/KtrE64i9TVEsswCNw2csyQLUgdMxdjsFlB9bSez1oxMzygQSMHezAnWWAEo30uQIPkTva4/rRVUuaJUApbUK3fg7XIByaouG2hKeK1oMywHagAdYh1cVACU6GdeZbZXCpIEasC+uJP0VAlVF3QOcd29cO4dEG/EzqnPOHheoNXXVVZci+gfDOoyyctRsjQAAAABJRU5ErkJggg==">
                </div>
                <div class="popup-table">
                    <div class="popup-flex-top">
                        <div class="popup-category">${cat}</div>
                        <div class="popup-action-btn-top">
                            <img class="popup-bookmark-cancel hide" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVR4nO3UPQ5BQRSG4UckFiCR2IPGApQKG7AFrdIWlFpbsAV7oNOjolELQW4yEsX9ReO6X3KSyeQ98+acYihjBtjjXrB2oTcz2zcev79IMnMLcK3g5E9JJUhMtaLvr8jPCnKD/yu4pYCNUB8J4sAOpjjghDl6nwqaGGGV8j1vMEH7HcHl5XzEDN1Qs3AXx+YWXLHEMGHvdfSxwLmIYI0xWnngkIiNeqLekuUB+OZ9sfhXLpUAAAAASUVORK5CYII="> 
                            <img class="popup-bookmark-cancel" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAbNJREFUaEPtWFtugzAQxBL/oTdo/wGJEzW5QXuS9galJ0LiAu0RyD8SXVdBIgjCPoZQVOcnCjGzMzu2114X7fzjds4/CgK2djA4EBwwZiBMIWMCza//PweqqnqktDVFUTTm9I0APDbhfktwRQ7UdV065569gK7rXvM8LyXB5sYS7pFw3+j/hL7LNE1PXFy2AJ+dOI6/hsAk4mQVcSH/McRt2/aJ64REQEICvL0HlIgp8oR9zrIsgTvgAWcCRhonUFhsB/qMIAIjMHo+YgFWJ5DkPReVAK0INHmTAKmINcibBXBFrEUeImBJxG8Q5672ef9Ms3NNba3qNTAGm8vyVFAUeZgDS1ssqvCt6gBHBDLzpjpwq8zfmkp/XgBnHaBFhEW8+22UU6Q4Y7jH5/E40xSSEJOMlYhRC9AQ0ryzJEYlwELE8i6kkCEIIDBUhQwZGIXFnkLUlfCXet+VuLpwWwrTjIiGLvUPS3Nf7MDu2yqXgtU3ts6U+RdrT2h0AHyn3wfC/STcI9yBHlDT/uOS0WCz1wCXxL3HBQH3zjj0LLQ1efideAtBYQ1skfVhzOBAcMCYgR9usHJAfCRJPwAAAABJRU5ErkJggg==">
                        </div>
                    </div>
                    <div class="pb-16">
                        <div>
                            <div class="popup-content-title">${iterator.content_title}</div>
                            <div class="popup-content">${iterator.content} ${iterator.imageBase64.length ==0 ? "": `<div style="width:0;height:0;"><img src="${iterator.imageBase64}" width="0" height="0" id="popup-image" /></div>`}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="popup-action-btn-bottom-container">
                <button type="button" class = "popup-action-btn-bottom ${iterator.link.length == 0?"":"hide" }">Read More</button>
                <button type="button" class = "popup-action-btn-bottom-cancel hide">Dismiss</button>
                <button type="button" class = "popup-action-btn-bottom-link ${iterator.link.length == 0?"hide":""}" data-id="${iterator.id}"><span>${visitLinkLightSVG}</span> Visit Link</button>
            </div>`
    )
} 
      
const initPopup = (result, localNotification) =>{
    let notifications = getValidNotification(result);
    if(localNotification.length > 0){
        let ids = localNotification.map((item)=> item.id);
        let newNotificaionts = notifications.filter(x=> !ids.includes(x.id));
        for(let item of newNotificaionts){
            let newObj = {
                "id" :  item.id,
                "isRead": false,
                "openCount" : item.Auto_open ? 3 : 0
            };
            localNotification.push(newObj);
        } 
    } 
    else {
        for(let item of notifications){
            let newObj = {
                "id" :  item.id,
                "isRead": false,
                "openCount" : item.Auto_open ? 3 : 0
            };
            localNotification.push(newObj);
        }        
    }
    let categories = removeDuplicates(getCategories(notifications));
    let pushNotifications = [];
    let htmlJSON = {
        "Internal Broadcast" : "",
        "Corporate IS":"",
        "OneTCS":""
    };
    let countNotification = {
        "Internal Broadcast" : 0,
        "Corporate IS": 0,
        "OneTCS": 0
    };
    for(const cat of categories){
        var cat_notification = notifications.filter(x=>x.category == cat);
        countNotification[cat] = cat_notification.length;
        for (const iterator of cat_notification) {
            let curIndex = localNotification.findIndex(x=> x.id == iterator.id);
            htmlJSON[cat] = htmlJSON[cat] + 
            `<div class="tab-items" data-id="${iterator.id}">
            <div class="tab-items-left">
              ${localNotification[curIndex]["isRead"]? notificationSVG : newNotificationSVG }
            </div>
            <div class="tab-items-right">
              <div class="tab-items-flex">
                <div class="tab-items-content-title">
                    <div class="tab-items-content-title-close">${iterator.content_title}</div>
                </div>
                <div class="tab-items-time-expand">
                  <span class="plr-4">${new Date(iterator.created_date).toLocaleDateString() == new Date().toLocaleDateString() ? formatAMPM(new Date(iterator.created_date)) : new Date(iterator.created_date).toLocaleString('default', { month: 'short' }) + ' ' + new Date(iterator.created_date).getDate() }</span>
                  <span class="tab-items-expand-collapse" data-id="${iterator.id}" >
                    ${iterator.link.length == 0 ? expandCollaspeSVG : visitLinkDarkSVG }
                  </span> 
                  <span class="tab-items-bookmarks hide">
                    <svg xmlns="http://www.w3.org/2000/svg" id="Bookmark" width="16" height="16" viewBox="0 -4 24 24">
                      <g id="bookmark_FILL1_wght400_GRAD0_opsz24" transform="translate(-194 -211)" fill="none"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                          d="M201.2,230.93a.848.848,0,0,1-.814-.075.8.8,0,0,1-.386-.719v-12.42A1.72,1.72,0,0,1,201.714,216h8.571A1.72,1.72,0,0,1,212,217.716v12.42a.8.8,0,0,1-.386.719.848.848,0,0,1-.814.075L206,228.87Z"
                          stroke="none"></path>
                        <path
                          d="M 209.8000030517578 228.1066741943359 L 209.8000030517578 218.1999969482422 L 202.1999969482422 218.1999969482422 L 202.1999969482422 228.1066589355469 L 205.1326141357422 226.8485412597656 C 205.6864471435547 226.6109313964844 206.3134918212891 226.6109313964844 206.8673553466797 226.8485412597656 L 209.8000030517578 228.1066741943359 M 211.1444244384766 231 C 211.0320129394531 231 210.9172210693359 230.9765319824219 210.8000030517578 230.9295806884766 L 205.9999847412109 228.8703460693359 L 201.1999969482422 230.9295806884766 C 200.9142761230469 231.0440521240234 200.6428527832031 231.0189514160156 200.3857116699219 230.8545227050781 C 200.1285705566406 230.6900634765625 200 230.4505310058594 200 230.1359100341797 L 200 217.7160339355469 C 200 217.2441253662109 200.1678619384766 216.8401336669922 200.5035552978516 216.5040893554688 C 200.8392791748047 216.1680297851562 201.2428436279297 216 201.7142639160156 216 L 210.2857208251953 216 C 210.7571411132812 216 211.1607055664062 216.1680297851562 211.4964294433594 216.5040893554688 C 211.8321380615234 216.8401336669922 212 217.2441253662109 212 217.7160339355469 L 212 230.1359100341797 C 212 230.4505310058594 211.8714141845703 230.6900634765625 211.6142730712891 230.8545227050781 C 211.4626312255859 230.9514923095703 211.3059997558594 231 211.1444244384766 231 Z"
                          stroke="none" fill="#525252"></path>
                      </g>
                      <path id="Path_10974" data-name="Path 10974" d="M0,0H24V24H0Z" fill="none"></path>
                    </svg>
                  </span>
                </div>
              </div>
              <div class="tab-items-content-close">
                ${iterator.content}
                ${iterator.imageBase64.length ==0 ? "": `<div style="width:0;height:0;"><img src="${iterator.imageBase64}" width="0" height="0" id="tab-items-image"/></div>`}
              </div>
            </div>
          </div>`;
          if(iterator.Auto_open){
            let notificationShowCount = localNotification.filter(x=> x.id == iterator.id)[0]["openCount"];            
            if(notificationShowCount > 0){
                createPopupNotification(pushNotifications, iterator, cat);
                let localIndex = localNotification.findIndex(x=> x.id == iterator.id);
                localNotification[localIndex]["openCount"] =  notificationShowCount - 1;
            }
          }
        }

    }

    chrome.storage.local.set({"user-notification": localNotification}).then(x=> {});
    
    let unreadNotificaiton = localNotification.filter(x=> !x.isRead);
    document.querySelector('body').insertAdjacentHTML('afterend', '<div class="popup-notitification hide"></div>');
    document.querySelector('body').insertAdjacentHTML('afterend', `<div class="notifications hide">
    <div class="container-top">
        <div class="left-top float-left">
            <div class="header float-left">TCS Announcements</div>
            <div class="new-notification float-right ${unreadNotificaiton.length > 0 ? "":"hide"}" data-count="${unreadNotificaiton.length}">${unreadNotificaiton.length > 99 ? "99+" : unreadNotificaiton.length} new</div>
        </div>
        <div class="right-top float-right ${unreadNotificaiton.length > 0 ? "":"no-border"}">
            <div class="float-left unread-notification ${unreadNotificaiton.length > 0 ? "":"hide"}" data-count="${unreadNotificaiton.length}">${unreadNotificaiton.length > 99 ? "99+" : unreadNotificaiton.length} unread</div>
            <div class="float-right mark-all-read">Mark all as read</div>
        </div>
    </div>
    <div class="nosubmit hide">
        <input class="nosubmit" type="search" placeholder="Search" />
    </div>
    <div class="tab">
        <div class="tablinks" data-id="Internal-Broadcast" id="defaultOpen">Internal Broadcast <span class="tab-badge">${countNotification["Internal Broadcast"]}</span></div>
        <div class="tablinks" data-id="Corporate-IS">Corporate IS <span class="tab-badge">${countNotification["Corporate IS"]}</span></div>
        <div class="tablinks" data-id="One-TCS">One TCS <span class="tab-badge">${countNotification["OneTCS"]}</span></div>
    </div>

    <div id="Internal-Broadcast" class="tabcontent">
        ${htmlJSON["Internal Broadcast"]}
    </div>
    <div id="Corporate-IS" class="tabcontent">
        ${htmlJSON["Corporate IS"]}
    </div>
    <div id="One-TCS" class="tabcontent">
        ${htmlJSON["OneTCS"]}
    </div>
</div>`);

    setTimeout(function(){
        document.querySelectorAll('.notifications .tab .tablinks').forEach(item=> {
            var id = item.getAttribute('data-id');
            item.addEventListener('click', function(evt){
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(id).style.display = "block";
                evt.currentTarget.className += " active";
            });
        });

        document.getElementById("defaultOpen").click();
        
        document.querySelector('.notifications .mark-all-read').addEventListener('click',function(){
            document.querySelectorAll('.notifications .tab-items').forEach(item=>{
                let notificationId = item.getAttribute('data-id');
                let newNotificationEle = document.querySelector('.notifications .new-notification');
                let unreadEle = document.querySelector('.notifications .unread-notification');
                let newCount = newNotificationEle.getAttribute('data-count');
                let countUnRead = localNotification.filter(x=>!x.isRead).length;
                let newSV = item.querySelector('.tab-items-left svg#new-notification');
                let notificationContainer = document.querySelector('.Notification-container .nbadge');
                if(newCount == countUnRead && countUnRead > 0 && newSV){
                    let count = countUnRead - 1;
                    newNotificationEle.innerHTML = countUnRead > 100 ? "99+ new" : count + " new";
                    unreadEle.innerHTML = countUnRead > 100 ? "99+ unread":count + " unread";
                    notificationContainer.innerHTML = count;
                    newNotificationEle.setAttribute('data-count',count);
                    if(count == 0){
                        newNotificationEle.classList.add('hide');
                        unreadEle.classList.add('hide');
                        unreadEle.parentElement.classList.add('no-border');
                    }
                }
                let localIndex = localNotification.findIndex(x=>x.id == notificationId);
                localNotification[localIndex]["isRead"] = true;
                item.querySelector('.tab-items-left').innerHTML = notificationSVG;
                chrome.storage.local.set({"user-notification": localNotification}).then(x=>{});
            })
        });

        document.querySelectorAll('.notifications .tab-items').forEach(item=>{
            item.addEventListener('click', function() {
                let contentTilte = item.querySelector('.tab-items-content-title-close') || item.querySelector('.tab-items-content-title');
                if(contentTilte.classList.contains("tab-items-content-title-close")){
                    contentTilte.classList.remove("tab-items-content-title-close");
                    let notificationId = item.getAttribute('data-id');
                    let newNotificationEle = document.querySelector('.notifications .new-notification');
                    let unreadEle = document.querySelector('.notifications .unread-notification');
                    let newCount = newNotificationEle.getAttribute('data-count');
                    let countUnRead = localNotification.filter(x=>!x.isRead).length;
                    let newSV = item.querySelector('.tab-items-left svg#new-notification');
                    let notificationContainer = document.querySelector('.Notification-container .nbadge');
                    if(newCount == countUnRead && countUnRead > 0 && newSV){
                        let count = countUnRead - 1;
                        newNotificationEle.innerHTML = countUnRead > 100 ? "99+ new" : count + " new";
                        unreadEle.innerHTML = countUnRead > 100 ? "99+ unread":count + " unread";
                        notificationContainer.innerHTML = count;
                        newNotificationEle.setAttribute('data-count',count);
                        if(count == 0){
                            newNotificationEle.classList.add('hide');
                            unreadEle.classList.add('hide');
                            unreadEle.parentElement.classList.add('no-border');
                        }
                    }
                    let localIndex = localNotification.findIndex(x=>x.id == notificationId);
                    localNotification[localIndex]["isRead"] = true;
                    item.querySelector('.tab-items-left').innerHTML = notificationSVG;
                    chrome.storage.local.set({"user-notification": localNotification}).then(x=>{});
                } else {
                    contentTilte.children[0].classList.add("tab-items-content-title-close");
                }
                let svgExpand = item.querySelector('#Expand');
                if(svgExpand == null && svgExpand == undefined){
                    let visitLink = item.querySelector('#Visit_Link_icon_dark');
                    if(visitLink != undefined && visitLink != null){
                        let notificationId = item.getAttribute('data-id');
                        let curNotifiction = notifications.filter(x=>x.id==notificationId)[0];
                        let localIndex = localNotification.findIndex(x=>x.id == notificationId);
                        localNotification[localIndex]["isRead"] = true;
                        item.querySelector('.tab-items-left').innerHTML = notificationSVG;
                        chrome.storage.local.set({"user-notification": localNotification}).then(x=>{});
                        let anchorTag = document.createElement('a');
                        anchorTag.setAttribute('target','_blank');
                        anchorTag.href = curNotifiction.link;
                        anchorTag.click();
                        anchorTag.remove();
                    }
                }
                else{                    
                    if(svgExpand.getAttribute('style') == undefined){
                        svgExpand.setAttribute('style','transform: rotate(180deg)');
                        svgExpand.setAttribute('viewBox', '0 4 24 24');
                    } else {
                        svgExpand.removeAttribute('style');
                        svgExpand.setAttribute('viewBox', '0 -4 24 24');
                    }
                    let tabContent = item.querySelector('.tab-items-content-close') || item.querySelector('.tab-items-content-open');
                    if(tabContent.classList.contains("tab-items-content-close")){
                        let img = item.querySelector('#tab-items-image');
                        if(img!=null && img!=undefined){
                            img.removeAttribute('width');
                            img.removeAttribute('height');
                            img.parentElement.removeAttribute('style');
                        }
                        tabContent.className = "tab-items-content-open";
                    } else {
                        tabContent.className = "tab-items-content-close";
                        let img = item.querySelector('#tab-items-image');
                        if(img!=null && img!=undefined){
                            img.setAttribute('width', 0);
                            img.setAttribute('height', 0);
                            img.parentElement.setAttribute('style', 'width:0;height:0');
                        }
                    }
                }
                
            });
        });

        let popupNotitfication = document.querySelector('.popup-notitification');
        let index = 0;
        setTimeout(function() {
            if(pushNotifications.length > index){
                popupNotitfication.innerHTML = pushNotifications[index];
                popupNotitficationFunction(popupNotitfication, index, pushNotifications, notifications);            
                popupNotitfication.classList.remove('hide');
            }
        },0);
    },0);
}

const popupNotitficationFunction = (popupNotitfication, index, pushNotifications, notifications) => {
    popupNotitfication.querySelectorAll('.popup-bookmark-cancel').forEach(item=> {
        if(!item.classList.contains('hide')){
            item.addEventListener('click', function(){
                popupNotitfication.classList.add('hide');
                popupNotitfication.innerHTML = "";
                setTimeout(function() {
                    index++;
                    if(pushNotifications.length > index){
                        popupNotitfication.innerHTML = pushNotifications[index];
                        popupNotitficationFunction(popupNotitfication, index, pushNotifications);
                        popupNotitfication.classList.remove('hide');
                    }
                }, 0)
            });
        }
    })
    let visitLink = popupNotitfication.querySelector('.popup-action-btn-bottom-link');
    if(visitLink.classList.contains("hide")){       
        popupNotitfication.querySelector('.popup-action-btn-bottom').addEventListener('click', function() {
            let popupCategory = popupNotitfication.querySelector('.popup-category') || popupNotitfication.querySelector('.popup-category-open');
            popupCategory.className = "popup-category-open";
            let popupActionTop = popupNotitfication.querySelector('.popup-action-btn-top');
            popupActionTop.className = "popup-action-btn-top-open";
            let popupContentTitle = popupNotitfication.querySelector('.popup-content-title');
            popupContentTitle.className = "popup-content-title-open";
            let popupContent = popupNotitfication.querySelector(".popup-content");
            popupContent.className = "popup-content-open";
            let img = popupNotitfication.querySelector('#popup-image');
            if(img!=null && img!=undefined){
                img.setAttribute('width', '80');
                img.setAttribute('height', '50');
                img.parentElement.removeAttribute('style');
            }
            popupNotitfication.querySelector('.popup-action-btn-bottom').classList.add('hide');
            popupNotitfication.querySelector('.popup-action-btn-bottom-cancel').classList.remove('hide');
        });
        popupNotitfication.querySelector('.popup-action-btn-bottom-cancel').addEventListener('click', function() {
            popupNotitfication.classList.add('hide');
            popupNotitfication.innerHTML = "";
            setTimeout(function() {
                index++;
                if(pushNotifications.length > index){
                    popupNotitfication.innerHTML = pushNotifications[index];
                    popupNotitficationFunction(popupNotitfication, index, pushNotifications);
                    popupNotitfication.classList.remove('hide');
                }
            }, 0)
        });
    } else {
        visitLink.addEventListener('click', function(e) {
            let notificationId = visitLink.getAttribute('data-id');
            if(notificationId!=undefined && notificationId != null){
                let curNotifiction = notifications.filter(x=> x.id == notificationId)[0];
                let anchorTag = document.createElement('a');
                anchorTag.setAttribute('target','_blank');
                anchorTag.href = curNotifiction.link;
                anchorTag.click();
                anchorTag.remove();
                popupNotitfication.innerHTML = "";
                popupNotitfication.classList.add('hide');
                setTimeout(function() {
                    index++;
                    if(pushNotifications.length > index){
                        popupNotitfication.innerHTML = pushNotifications[index];
                        popupNotitficationFunction(popupNotitfication, index, pushNotifications);
                        popupNotitfication.classList.remove('hide');
                    }
                }, 0)
            }
        });
    }
}

const app = async ()=> {
    await init();
}

app();